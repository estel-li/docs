---
title: Iperf3 万兆网络打流测试指南
description: Iperf3 万兆网络打流测试指南
published: undefined
img: https://img.jiwei.xin/20250615184111247.png
date: 2025-05-13 00:00:00.000Z
---


> 🔍 **文档说明**: 本文记录基于水星S106E Pro交换机的万兆网络Iperf3性能测试，涵盖设备连接、测试参数配置及结果分析。适用于**网络性能测试初学者**及**运维人员**。

## 技术TAG
`#Iperf3` `#万兆网络测试` `#交换机配置` `#AQC113网卡` `#网络性能分析`

---

## 一、测试环境配置
### 设备拓扑图
```mermaid
graph LR
A[MacBook Air M4] -- 雷电/万兆电口 --> B[水星S106E Pro<br>万兆光口]
B -- 万兆光口 --> C[PVE服务器<br>CX4121A网卡]
```

### 硬件清单

| **设备**           | **规格**                                | **作用**               |
|---------------------|-----------------------------------------|-----------------------|
| 主测试端           | MacBook Air M4 + 雷电万兆网卡(AQC113)   | Iperf3 Client端       |
| 交换机             | 水星S106E Pro                           | 万兆光/电转换枢纽     |
| 光转电模块         | AQR113光转电模块                        | 连接交换机万兆光口    |
| 被测服务端         | NAS (12500T+Q670) + CX4121A万兆网卡     | Iperf3 Server端       |
| 辅助设备           | 超六类网线/光纤跳线(按需)               | 物理链路连接          |


---

## 二、Iperf3安装与配置
### 1. macOS端安装（Client）
```bash
# 通过Homebrew安装iperf3
    brew install iperf3

# 启动服务端监听（可选本地验证）
    iperf3 -s -p 5201
```

### 2. PVE服务端安装（Server）
```bash
# Debian系系统安装
    apt update && apt install iperf3 -y

# 启动服务端后台监听
    iperf3 -s -D -p 5201
```
> ⚠️ **防火墙注意**: 确保5201端口开放
> `ufw allow 5201/tcp` (Debian/Ubuntu)
> `firewall-cmd --add-port=5201/tcp --permanent` (CentOS)
```

## 三、典型测试场景
### 场景1：TCP带宽测试（默认参数）
```bash
# Client端执行（MacBook）
iperf3 -c <Server_IP> -p 5201 -t 60

# 参数说明：
# -c : 服务端IP地址
# -t : 测试持续时间(秒)
```

### 场景2：多线程UDP压力测试
```bash
iperf3 -c <Server_IP> -p 5201 -u -b 10G -P 4

# 参数说明：
# -u : 使用UDP协议
# -b : 指定带宽(10G速率)
# -P : 并行线程数
```


### 场景3：双向流量测试
```bash
# 同时测试上行+下行
iperf3 -c <Server_IP> -p 5201 --bidir
```

---

## 四、测试结果分析要点
### 关键性能指标
| **字段**         | **健康值范围**          | **异常排查方向**       |
|------------------|-------------------------|------------------------|
| Bandwidth        | >9.5Gbps (万兆场景)      | 网卡协商/模块兼容性     |
| Jitter           | <1ms (UDP测试)          | 交换机缓存/线缆质量    |
| Packet Loss      | 0%                      | 缓冲区设置/CPU性能     |
| TCP Retransmits  | <0.1%                   | TCP窗口/MTU配置        |

> 💡 **优化建议**：
> 1. 使用`-w`调整TCP窗口大小（例如`-w 8M`）
> 2. 尝试`--omit N`跳过初始N秒不稳定数据
> 3. 添加`-J`参数获取JSON格式结构化结果

---

## 五、常见问题解决
### ❌ 问题1：协商速率降级至1Gbps
```bash
# 检查网卡协商状态（MacOS）
ifconfig enX | grep media

# 解决方案：
1. 更换光模块/AOC线缆排除物理故障
2. 检查交换机端口配置（禁用节能模式）
```

### ❌ 问题2：测试中突发丢包
```bash
# 动态查看QoS统计（PVE服务器）
ethtool -S enpXX | grep -E 'drop|error'

# 解决方案：
1. 调整网卡缓冲区：ethtool -G enpXX rx/tx 4096
2. 减少并发线程总数（-P参数）
```

 📌 **经验总结**：水星S106E Pro需关闭"绿色节能"功能，避免AQC113因节能策略降速。PVE虚拟机环境建议使用SR-IOV直通网卡，减少虚拟化层开销。

---

**测试文档版本**: v1.1
**更新日期**: 2023-12-15
**测试工具版本**: iperf 3.16 (macOS)/iperf 3.7 (Linux)
